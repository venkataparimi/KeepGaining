# Copilot Instructions for KeepGaining Project

## Critical Rules - DO NOT VIOLATE

### 1. Terminal Management
- **NEVER run long-running commands (downloads, servers, background processes) in terminals that have other active processes**
- **NEVER run commands in parallel terminals** - wait for one to complete before starting another
- **For long-running tasks**: Ask the user to run them manually in a separate terminal
- **Background processes (isBackground=true)**: Only use for servers or watch processes that are meant to run indefinitely

### 2. Script Management
- **DO NOT create temporary debug scripts** - Use existing service methods and CLI tools
- **All data operations should go through `DataDownloadService`** - This is the enterprise architecture approach
- **Use `scripts/data_cli.py`** for all data download operations
- **If you must create a test script**: Put it in `scripts/temp/` folder and clean up after

### 3. API Knowledge - Upstox
- **Expired Instruments API `underlying_key` format**:
  - Index: `NSE_INDEX|Nifty 50`, `NSE_INDEX|Nifty Bank`
  - Stock: `NSE_EQ|{ISIN}` (e.g., `NSE_EQ|INE002A01018` for RELIANCE)
  - **NOT** `NSE_EQ|RELIANCE` - this is WRONG
- **Get `underlying_key` from instrument master**, not by constructing it manually
- **Token expires after ~24 hours** - Check validity before running downloads
- **Always call `provider.authenticate()` or `service.initialize()` before API calls**

### 4. Database Operations
- **Check data status first**: `python scripts/data_cli.py status`
- **Don't assume tables exist** - Use the status command to verify

### 5. Code Changes
- **Read the SDK documentation first** (in `upstox-python-master/docs/`)
- **Don't guess API formats** - Check the actual data from instrument master
- **Test with a single item first** before running bulk operations

### 6. CLI Commands Reference
```powershell
# Always cd to backend first
cd c:\code\KeepGaining\backend

# Check status
python scripts/data_cli.py status

# Download equity data
python scripts/data_cli.py download-equity --from-date 2022-01-01

# Download index F&O (expired historical)
python scripts/data_cli.py download-fo --months 6

# Download stock F&O (expired historical)
python scripts/data_cli.py download-stock-fo --months 6

# Get auth URL for new token
python test_upstox.py get_auth_url

# Exchange auth code for token
python test_upstox.py exchange_code <CODE>
```

### 7. When User Reports Repeated Issues
- **Stop and create/update this instruction file**
- **Acknowledge the pattern** before proceeding
- **Don't repeat the same mistake** - Read this file first

## Project Structure
- `backend/app/services/data_download_service.py` - Main data download service
- `backend/app/services/data_providers/upstox.py` - Upstox API provider
- `backend/scripts/data_cli.py` - CLI for data operations
- `backend/scripts/temp/` - Temporary test scripts (clean up after use)
- `backend/upstox-python-master/docs/` - Upstox SDK documentation
- `backend/data/upstox_token.json` - Upstox access token

## Current Data Status (as of session)
- ~98.9M candles in database
- Equity: 200 stocks from 2022
- Index F&O: NIFTY, BANKNIFTY options/futures (6 months expired data)
- Stock F&O: Limited - needs download via `download-stock-fo` command

---

# HIGH LEVEL DESIGN - MUST FOLLOW

> **Full document at `docs/HIGH_LEVEL_DESIGN.md`**

## System Overview

**KeepGaining** is a personal algorithmic trading system for Indian equity markets. It is:
- Event-driven architecture using Redis Streams
- Multi-broker (Fyers for trading, Upstox for data)
- Intraday options trading focused (buying options on F&O stocks)
- Full lifecycle: market data â†’ candles â†’ indicators â†’ signals â†’ orders â†’ positions

## Architecture Principles - MUST FOLLOW

### Event-Driven Architecture
```
[Data Sources] â†’ [Event Bus (Redis)] â†’ [Processing Services] â†’ [Actions]
```

All services communicate through events. DO NOT create tight coupling between services.

### Event Flow (DO NOT BREAK THIS FLOW)
```
TICK â†’ CANDLE â†’ INDICATOR_UPDATED â†’ SIGNAL â†’ ORDER â†’ POSITION_UPDATE
```

### Event Types (from `app/core/events.py`)
| Event Type | Publisher | Subscribers |
|------------|-----------|-------------|
| `TICK` | Data Feed | Candle Builder, Storage |
| `CANDLE` | Candle Builder | Indicator Engine, Storage |
| `INDICATOR_UPDATED` | Indicator Engine | Strategy Engine |
| `SIGNAL` | Strategy Engine | Order Manager |
| `ORDER` | Order Manager | Position Manager, Risk Manager |
| `POSITION_UPDATE` | Position Manager | Risk Manager, UI |

## Core Components

### 1. Data Feed (`app/services/data_feed.py`)
- Receives live ticks from broker WebSocket
- Publishes `TICK` events to Redis Streams
- Handles reconnection, heartbeats

### 2. Candle Builder (`app/services/candle_builder.py`)
- Subscribes to `TICK` events
- Aggregates ticks into 1m, 5m, 15m candles
- Publishes `CANDLE` events

### 3. Indicator Service (`app/services/indicator_service.py`)
- Subscribes to `CANDLE` events
- Computes EMA, RSI, MACD, Supertrend, etc.
- Publishes `INDICATOR_UPDATED` events

### 4. Strategy Engine (`app/services/strategy_engine.py`)
- Subscribes to `INDICATOR_UPDATED` events
- Runs registered strategies
- Publishes `SIGNAL` events (buy/sell)

### 5. Order Manager (`app/execution/order_manager.py`)
- Subscribes to `SIGNAL` events
- Validates against risk limits
- Places orders via broker API
- Publishes `ORDER` events

### 6. Position Manager (`app/execution/position_manager.py`)
- Subscribes to `ORDER` events
- Tracks open positions, P&L
- Publishes `POSITION_UPDATE` events

### 7. Risk Manager (`app/execution/risk_manager.py`)
- Monitors positions, daily P&L
- Enforces limits (max positions, max loss)
- Can halt trading (kill switch)

## Database Schema

### Key Tables
- `instruments` - Equity master data (symbol, ISIN, lot_size)
- `option_master` - Option contracts (strike, expiry, underlying)
- `future_master` - Future contracts (expiry, underlying)
- `candles_1m` - 1-minute OHLCV (TimescaleDB hypertable)
- `indicator_values` - Computed indicators
- `signals` - Generated signals
- `orders` - Order history
- `positions` - Active positions
- `trades` - Executed trades
- `daily_pnl` - Daily P&L tracking

### Data Model Relationships
```
instruments (1) â†’ (N) option_master/future_master
instruments (1) â†’ (N) candles_1m
candles_1m (1) â†’ (N) indicator_values
signals (1) â†’ (N) orders
orders (N) â†’ (1) positions
positions (N) â†’ (1) trades
```

## Multi-Broker Integration

### Fyers (Primary Trading)
- **Use for**: Live trading, WebSocket feeds (200 instruments)
- **Rate limits**: 10/sec, 200/min
- **Config**: `FYERS_CLIENT_ID`, `FYERS_ACCESS_TOKEN`

### Upstox (Data Provider)
- **Use for**: Historical data, batch quotes (500/call), expired contracts
- **Rate limits**: 2000/min (excellent for backfill)
- **Config**: `UPSTOX_API_KEY`, `UPSTOX_ACCESS_TOKEN`

### Paper Broker
- **Use for**: Backtesting, paper trading
- Simulates fills, slippage, partial fills

## Risk Management Rules

### Position Limits
- Max 5 concurrent positions
- Max â‚¹2L per position
- Max â‚¹10L total exposure

### Loss Limits
- Max â‚¹10,000 daily loss â†’ HALT TRADING
- Max â‚¹30,000 weekly loss
- 3 consecutive losses â†’ reduce size 50%

### Circuit Breakers
- Daily loss limit hit â†’ automatic halt
- Broker disconnect â†’ no new orders
- Data feed disconnect â†’ pause signals

## Market Calendar Integration

### Trading Hours (IST)
- Pre-open: 09:00 - 09:15
- Regular: 09:15 - 15:30
- Post-close: After 15:30

### DO NOT
- Place orders outside market hours
- Generate signals before 09:16 (opening volatility)
- Hold positions after 15:15 (auto square-off buffer)

## Technology Stack

| Component | Technology |
|-----------|------------|
| **Backend** | Python 3.12+, FastAPI, asyncio |
| **Database** | PostgreSQL 15+ with TimescaleDB |
| **Event Bus** | Redis 7+ Streams |
| **Frontend** | Next.js 14, TypeScript, Tailwind |
| **Data Processing** | Pandas, NumPy |

## Implementation Phases

### Phase 1: MVP (Current)
- âœ… Core event bus
- âœ… Data download (equity, F&O)
- âœ… Candle building
- âœ… Indicator computation
- ðŸ”„ Signal generation
- ðŸ”„ Paper trading validation
- ðŸ”„ Backtest engine

### Phase 2: Live Trading
- [ ] Fyers WebSocket integration
- [ ] Live order placement
- [ ] Position tracking
- [ ] Risk management
- [ ] Telegram alerts

### Phase 3: Enhancement
- [ ] Multiple strategies
- [ ] Greeks computation
- [ ] Advanced backtesting
- [ ] Performance analytics

## Code Patterns - MUST FOLLOW

### Event Publishing
```python
# Always use BaseEvent subclass
from app.core.events import TickEvent, EventBus

event = TickEvent(
    instrument_id=str(instrument.id),
    symbol=symbol,
    ltp=price,
    ...
)
await event_bus.publish(event)
```

### Event Subscription
```python
# Services subscribe in start() method
async def start(self):
    await self.event_bus.subscribe(
        event_type=EventType.CANDLE,
        callback=self._handle_candle
    )
```

### Service Lifecycle
```python
class MyService:
    async def start(self):
        # Subscribe to events
        # Start background tasks
        
    async def stop(self):
        # Unsubscribe from events
        # Cleanup resources
```

### Database Sessions
```python
# Use dependency injection
from app.db.session import get_db

async def my_endpoint(db: Session = Depends(get_db)):
    ...
```

## DO NOT

1. **DO NOT bypass the event bus** - All service communication goes through events
2. **DO NOT call broker APIs directly** - Use the broker abstraction layer
3. **DO NOT skip risk checks** - All orders must pass risk validation
4. **DO NOT hard-code credentials** - Use environment variables
5. **DO NOT create synchronous blocking code** - Use async/await
6. **DO NOT ignore market hours** - Check calendar before trading operations
7. **DO NOT modify candle data after storage** - Candles are immutable
8. **DO NOT mix broker data formats** - Normalize through adapters

## Glossary

| Term | Definition |
|------|------------|
| ATM | At The Money - strike nearest to spot |
| CE/PE | Call/Put Option |
| F&O | Futures & Options |
| OI | Open Interest |
| MIS | Margin Intraday Square-off |
| NRML | Normal (overnight positions) |
| SL | Stop Loss |
| VWAP | Volume Weighted Average Price |
